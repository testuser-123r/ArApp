<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>AR Ball Spiel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js Library -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #score {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 1;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            color: red;
            font-family: Arial, sans-serif;
            display: none;
            z-index: 1;
            text-align: center;
        }
        #instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 1;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="score">Punkte: 0</div>
    <div id="game-over">
        Spiel Vorbei!<br>
        <button onclick="restartGame()">Neu Starten</button>
    </div>
    <div id="instructions">
        Zeige den Hiro Marker vor die Kamera, um das Spiel zu starten.
    </div>

    <a-scene embedded arjs>
        <!-- Kamera mit Cursor -->
        <a-camera>
            <a-cursor 
                fuse="false" 
                raycaster="objects: .clickable"
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                material="color: white; shader: flat">
            </a-cursor>
        </a-camera>

        <!-- Hiro Marker -->
        <a-marker type="pattern" url="Hiro.patt" id="hiro-marker">
            <!-- Optional: Weitere Marker-basierte Objekte hier hinzufügen -->
        </a-marker>

        <!-- Ball (initial unsichtbar und unabhängig vom Marker) -->
        <a-sphere id="ball" class="clickable" position="0 5 -2" radius="0.3" color="#FF0000" visible="false"></a-sphere>

        <!-- Licht -->
        <a-entity light="type: ambient; color: #BBB"></a-entity>
        <a-entity light="type: directional; intensity: 0.5" position="1 1 0"></a-entity>
    </a-scene>

    <script>
        let score = 0;
        let gameOver = false;
        const scoreElement = document.getElementById('score');
        const gameOverElement = document.getElementById('game-over');
        const instructions = document.getElementById('instructions');
        const ball = document.querySelector('#ball');
        let ballVelocity = -0.02; // Startet mit fallender Geschwindigkeit (Y-Richtung)
        const lowerBound = -1; // Untere Grenze für das Spielende (Y-Position)
        let animationFrameId;

        // Definiere die drei festen Startpositionen (Mitte, links, rechts)
        const spawnPositions = [
            { x: 0, y: 5, z: -2 },    // Mitte oben, vor dem Marker
            { x: -1, y: 5, z: -2 },   // Links oben
            { x: 1, y: 5, z: -2 }     // Rechts oben
        ];

        // Funktion zum zufälligen Spawn des Balls
        function spawnBall() {
            // Wähle zufällig eine der drei Positionen
            const spawnPos = spawnPositions[Math.floor(Math.random() * spawnPositions.length)];
            ball.setAttribute('position', spawnPos);
            ball.setAttribute('visible', 'true');
            ballVelocity = -0.02; // Setze die Fallgeschwindigkeit zurück
            // Starte die Ball-Animation
            cancelAnimationFrame(animationFrameId); // Stelle sicher, dass keine vorherige Animation läuft
            updateBall();
        }

        // Funktion zum Aktualisieren des Balls
        function updateBall() {
            if (gameOver) return;

            // Aktuelle Position des Balls
            let pos = ball.getAttribute('position');
            pos.y += ballVelocity;
            ball.setAttribute('position', pos);

            // Prüfen, ob der Ball den unteren Bereich erreicht hat
            if (pos.y < lowerBound) {
                endGame();
                return;
            }

            animationFrameId = requestAnimationFrame(updateBall);
        }

        // Funktion zum Schlagen des Balls
        function hitBall() {
            if (gameOver) return;
            // Setze die Geschwindigkeit, sodass der Ball nach oben geht
            ballVelocity = 0.02;
            score += 1;
            scoreElement.innerText = 'Punkte: ' + score;

            // Nach kurzer Zeit wieder fallen lassen
            setTimeout(() => {
                spawnBall();
            }, 300);
        }

        // Funktion zum Beenden des Spiels
        function endGame() {
            gameOver = true;
            gameOverElement.style.display = 'block';
            cancelAnimationFrame(animationFrameId);
            ball.setAttribute('visible', 'false');
        }

        // Funktion zum Neustarten des Spiels
        function restartGame() {
            // Reset Spielstatus
            score = 0;
            scoreElement.innerText = 'Punkte: 0';
            gameOver = false;
            gameOverElement.style.display = 'none';
            // Spawn den Ball an einer zufälligen Position
            spawnBall();
        }

        // Event Listener für das Schlagen des Balls
        ball.addEventListener('click', hitBall);

        // Marker erkannt
        const marker = document.querySelector('#hiro-marker');
        marker.addEventListener('markerFound', () => {
            console.log('Hiro Marker gefunden');
            instructions.style.display = 'none';
            // Spawn den Ball an einer zufälligen Position
            spawnBall();
        });

        // Marker verloren
        marker.addEventListener('markerLost', () => {
            console.log('Hiro Marker verloren');
            // Optional: Spiel beenden, wenn Marker verloren geht
            if (!gameOver) {
                endGame();
            }
        });

        // Initialer Zustand
        ball.setAttribute('visible', 'false');
    </script>
</body>
</html>
