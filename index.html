<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Markerloses AR Ball Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- A-Frame Extras für AR-Integration -->
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #score {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: white;
            z-index: 1;
            font-family: Arial, sans-serif;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
        }
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            color: red;
            display: none;
            z-index: 1;
            font-family: Arial, sans-serif;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div id="score">Punkte: 0</div>
    <div id="gameOver">Spiel Vorbei!</div>

    <a-scene embedded arjs='sourceType: webcam;'>
        <!-- Kamera -->
        <a-entity camera></a-entity>

        <!-- Lichtquellen -->
        <a-entity light="type: ambient; color: #FFFFFF"></a-entity>
        <a-entity light="type: directional; color: #FFFFFF; intensity: 0.5" position="1 1 1"></a-entity>

        <!-- Bereich, in dem die Bälle spawnen -->
        <a-entity id="spawnArea" position="0 0 0"></a-entity>
    </a-scene>

    <script>
        // Initialisierung der Variablen
        let score = 0;
        const scoreElement = document.getElementById('score');
        const gameOverElement = document.getElementById('gameOver');
        const scene = document.querySelector('a-scene');
        const spawnArea = document.getElementById('spawnArea');
        const balls = [];
        let gameOver = false;

        // Einstellungen
        const spawnInterval = 2000; // in Millisekunden
        const fallDuration = 3000; // in Millisekunden (3 Sekunden zum Fallen)
        const spawnHeight = 1; // Start y-Position
        const spawnRange = 0.5; // Bereich für x und z

        // Funktion zum Spawnen von Bällen
        function spawnBall() {
            if (gameOver) return;

            const ball = document.createElement('a-sphere');
            const x = (Math.random() - 0.5) * 2 * spawnRange;
            const z = (Math.random() - 0.5) * 2 * spawnRange;
            ball.setAttribute('position', `${x} ${spawnHeight} ${z}`);
            ball.setAttribute('radius', 0.05);
            ball.setAttribute('color', '#FF0000');
            ball.setAttribute('class', 'ball');
            ball.setAttribute('dynamic-body', 'mass: 1;');

            // Event Listener für das Treffen des Balls
            ball.addEventListener('click', () => {
                if (gameOver) return;
                scene.removeChild(ball);
                const index = balls.indexOf(ball);
                if (index > -1) {
                    balls.splice(index, 1);
                }
                score += 1;
                scoreElement.innerText = `Punkte: ${score}`;
            });

            spawnArea.appendChild(ball);
            balls.push(ball);

            // Set start time
            ball.setAttribute('data-start-time', Date.now());
        }

        // Ball-Spawning Interval
        const ballSpawner = setInterval(spawnBall, spawnInterval);

        // Update-Funktion
        function updateBalls() {
            if (gameOver) return;

            const currentTime = Date.now();

            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                const pos = ball.getAttribute('position');
                const startTime = ball.getAttribute('data-start-time') || currentTime;
                const elapsed = currentTime - startTime;

                // Berechne die neue y-Position basierend auf der verstrichenen Zeit
                const newY = spawnHeight - (spawnHeight * (elapsed / fallDuration));
                ball.setAttribute('position', `${pos.x} ${newY} ${pos.z}`);

                // Überprüfen, ob der Ball den Boden erreicht hat
                if (elapsed >= fallDuration) {
                    endGame();
                    break;
                }
            }

            requestAnimationFrame(updateBalls);
        }

        // End Game Funktion
        function endGame() {
            gameOver = true;
            clearInterval(ballSpawner);
            gameOverElement.style.display = 'block';
            // Entfernen aller verbleibenden Bälle
            balls.forEach(ball => spawnArea.removeChild(ball));
            balls.length = 0;
        }

        // Start der Update-Schleife, sobald die Szene geladen ist
        scene.addEventListener('loaded', () => {
            updateBalls();
        });
    </script>
</body>
</html>
